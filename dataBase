import sqlalchemy as db
from datetime import datetime
import random

# Create engine
engine = db.create_engine('sqlite:///KSU.db')
conn = engine.connect()
metadata = db.MetaData()

# Students Table
Students = db.Table(
    'Students', metadata,
    db.Column('Student_id', db.Integer, primary_key=True, nullable=False),
    db.Column('F_name', db.String(), nullable=False),
    db.Column('L_name', db.String(), nullable=False),
    db.Column('Password', db.String(6), nullable=False),
    db.Column('Email', db.String(), nullable=False),
    db.Column('Phone', db.String(10), nullable=False),
)

# Wallets Table
Wallets = db.Table(
    'Wallets', metadata,
    db.Column('wId', db.Integer, primary_key=True, nullable=False),
    db.Column('Student_id', db.Integer, db.ForeignKey('Students.Student_id')),
    db.Column('Balance', db.Float, nullable=False),
    db.Column('Wallet_type', db.String(), nullable=False),
    db.Column('Created_at', db.String(), nullable=False)
)

# Entities Table
Entities = db.Table(
    'Entities', metadata,
    db.Column('Entity_name', db.String(), primary_key=True, nullable=False),
    db.Column('Wallet_number', db.Integer, db.ForeignKey('Wallets.wId'), nullable=False)
)

# Create tables
metadata.create_all(engine)


# ============================================================
#                   METHODS SECTION

def add_student(student_id, fname, lname, password, email, phone, wallet_id):
    ins_student = Students.insert().values(
        Student_id=student_id,
        F_name=fname,
        L_name=lname,
        Password=password,
        Email=email,
        Phone=phone
    )
    conn.execute(ins_student)

    ins_wallet = Wallets.insert().values(
        wId=wallet_id,
        Student_id=student_id,
        Balance=1000,
        Wallet_type="student",
        Created_at=str(datetime.now())
    )
    conn.execute(ins_wallet)


def login_check(student_id, password):
    s = Students.select().where((Students.c.Student_id == student_id) & (Students.c.Password == password))
    return conn.execute(s).fetchone()


def get_wallet(student_id):
    s = Wallets.select().where(Wallets.c.Student_id == student_id)
    return conn.execute(s).fetchone()


def wallet_exists(wallet_number):
    s = Wallets.select().where(Wallets.c.wId == wallet_number)
    return conn.execute(s).fetchone()


def transfer_amount(sender_wallet, receiver_wallet, amount):
    conn.execute(
        Wallets.update()
        .where(Wallets.c.wId == sender_wallet)
        .values(Balance=Wallets.c.Balance - amount)
    )
    conn.execute(
        Wallets.update()
        .where(Wallets.c.wId == receiver_wallet)
        .values(Balance=Wallets.c.Balance + amount)
    )


def get_entities():
    return conn.execute(Entities.select()).fetchall()


def get_entity_balance(wallet_number):
    s = Wallets.select().where(Wallets.c.wId == wallet_number)
    return conn.execute(s).fetchone()


def add_entity(entity_name, wallet_number):

    check = Entities.select().where(Entities.c.Entity_name == entity_name)
    if conn.execute(check).fetchone():
        raise ValueError("Entity already exists.")

    conn.execute(
        Wallets.insert().values(
            wId=wallet_number,
            Student_id=None,
            Balance=0,
            Wallet_type="KSU",
            Created_at=str(datetime.now())
        )
    )

    conn.execute(
        Entities.insert().values(
            Entity_name=entity_name,
            Wallet_number=wallet_number
        )
    )


def pay_stipends():
    conn.execute(
        Wallets.update()
        .where(Wallets.c.Wallet_type == "student")
        .values(Balance=Wallets.c.Balance + 1000)
    )


def cash_out():
    conn.execute(
        Wallets.update()
        .where(Wallets.c.Wallet_type == "KSU")
        .values(Balance=0)
    )


def add_admin():

    admin_id = 1111111111
    passw = 000000

    if login_check(admin_id, passw):
        return

    wallet_id = ''.join([str(random.randint(0, 9)) for _ in range(10)])

    conn.execute(
        Students.insert().values(
            Student_id=admin_id,
            F_name='shouq',
            L_name='sami',
            Password='000000',
            Email='shouq@gmail.com',
            Phone='0541009383'
        )
    )

    conn.execute(
        Wallets.insert().values(
            wId=wallet_id,
            Student_id=admin_id,
            Balance=0,
            Wallet_type="admin",
            Created_at=str(datetime.now())
        )
    )

    print(f"Admin added successfully. Wallet number: {wallet_id}")

def generate_wallet_number(self):
     return ''.join([str(random.randint(0, 9)) for _ in range(10)])
add_admin()
