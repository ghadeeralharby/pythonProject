import tkinter as tk
from tkinter import ttk
from tkinter.ttk import Labelframe
import dataBase
from datetime import datetime
import re
from random import *
from random import randint

from tkinter import messagebox

class AdminWindow:
    def __init__(self):
        self.Admin_window = tk.Toplevel()
        self.Admin_window.title("Admin Window")
        self.Admin_window.geometry("500x400")

        #----notebook----
        self.notebook = ttk.Notebook(self.Admin_window)
        self.notebook.pack(fill="both", expand=True)

        #---- TAB 1 (VIEW) ----
        self.viewTab= tk.Frame(self.notebook)
        self.notebook.add(self.viewTab, text="View")

        #----TAB2 (ADD) ----
        self.addTab= tk.Frame(self.notebook)
        self.notebook.add(self.addTab, text="Add")

        #----TAB3 (MANAGE) ----
        self.manageTab= tk.Frame(self.notebook)
        self.notebook.add(self.manageTab, text="Manage")

        self.back_button = tk.Button(
            self.Admin_window,
            text="Back",
            width=10,
            command=self.go_back
        )
        self.back_button.pack(pady=10)

        self.build_view_tab()
        self.build_addTab()
        self.manage_tap()



    def build_view_tab(self):
        self.viewFrame = ttk.LabelFrame(self.viewTab, text="View KSU Entities")
        self.viewFrame.pack(pady=20, padx=20, fill="both", expand=True)

        self.entities_label = tk.Label(self.viewFrame, text="Select an Entity")
        self.entities_label.grid(row=0, column=0, sticky="w", pady=8)

        self.entities_cb = ttk.Combobox(self.viewFrame, width=28)
        self.entities_cb.grid(row=1, column=0, pady=8)

        self.viewButton = tk.Button(self.viewFrame, text="View Balance", command=self.view_balance)
        self.viewButton.grid(row=2, column=0, pady=10)

        self.balance_label = tk.Label(self.viewFrame, text="Balance:---SR")
        self.balance_label.grid(row=3, column=0, pady=10)

        self.load_entities()


    def load_entities(self):
        try:
            rows = dataBase.get_entities()
            if rows:
                names = [row[0] for row in rows]
                self.entities_cb["values"] = names
            else:
                self.entities_cb["values"] = ["No entities found"]
        except Exception as e:
            self.entities_cb["values"] = [f"Error: {e}"]

    def view_balance(self):
        entity_name = self.entities_cb.get().strip()

        if entity_name == "" or entity_name == "No entities found":
            self.balance_label.config(text="Balance: --- SR")
            return

        rows = dataBase.get_entities()

        wallet_number = None
        for row in rows:
            if row[0] == entity_name:
                wallet_number = row[1]
                break

        if wallet_number is None:
            self.balance_label.config(text="Balance: entity not found")
            return

        wallet_row = dataBase.get_entity_balance(wallet_number)

        if wallet_row is None:
            self.balance_label.config(text="Balance: No wallet found")
            return

        balance = wallet_row[2]
        self.balance_label.config(text=f"Balance: {balance} SR")

    def build_addTab(self):
        self.addFrame = ttk.LabelFrame(self.addTab , text="Add KSU Entities")
        self.addFrame.pack(pady=20 , padx=20 , fill="both", expand=True)
        self.addFrame.columnconfigure(0, weight=1)
        self.label2=tk.Label(self.addFrame, text="KSU Entity Name:").pack(pady=5)
        self.entity_name_entry = tk.Entry(self.addFrame, width=30)
        self.entity_name_entry.pack(pady=5)

        #def generate_wallet_number():
         #   return ''.join([str(random.randint(0, 9)) for _ in range(10)])

        def on_submit():
            entity_name = self.entity_name_entry.get().strip()
            if not entity_name:
                messagebox.showerror("Error", "Please enter entity name!")
                return

            if entity_name in dataBase.get_entities():
                messagebox.showerror("Error", "KSU entity already registered!")
            else:
                wallet_number = dataBase.generate_wallet_number(entity_name)
                dataBase.add_entity(entity_name, wallet_number)
                messagebox.showinfo("Success", f"Entity {entity_name} added with wallet number {wallet_number}")
                self.entity_name_entry.delete(0, tk.END)

        tk.Button(self.addFrame, text="Submit", command=on_submit, width=15).pack(pady=10)


    def manage_tap(self):
        self.manageFrame = tk.LabelFrame(self.manageTab, text="Manage KSU Wallets")
        self.manageFrame.pack(pady=20, padx=20, fill="both", expand=True)

        self.pay_btn = tk.Button(self.manageFrame, text="Pay Stipends", command=self.pay_stipends_action)
        self.pay_btn.grid(row=0, column=0, pady=10, sticky="ew")

        self.cashout_btn = tk.Button(self.manageFrame, text="Cash Out", command=self.cashout_action)
        self.cashout_btn.grid(row=1, column=0, pady=10, sticky="ew")


    def pay_stipends_action(self):
        try:
            dataBase.pay_stipends()
            messagebox.showinfo("Success", "1000 SR added to all student wallets.")
        except Exception as e:
            messagebox.showerror("Error", str(e))


    def cashout_action(self):
        try:
            dataBase.cash_out()
            messagebox.showinfo("Success", "All KSU entity wallets reset to 0.")
        except Exception as e:
            messagebox.showerror("Error", str(e))

    def go_back(self):
        from signUp import SignupWindow
        self.Admin_window.destroy()
        SignupWindow()



if __name__ == "__main__":
    AdminWindow()
